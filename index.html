import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, increment, enableIndexedDbPersistence } from 'firebase/firestore';

// Helper function to convert base64 to ArrayBuffer for audio playback
function base64ToArrayBuffer(base64) {
    const binaryString = window.atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

// Helper function to convert PCM to WAV for audio playback
function pcmToWav(pcm16, sampleRate) {
    const dataLength = pcm16.length * 2; // 2 bytes per sample
    const buffer = new ArrayBuffer(44 + dataLength);
    const view = new DataView(buffer);

    // RIFF identifier
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + dataLength, true); // file length
    writeString(view, 8, 'WAVE');
    // FMT chunk
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true); // chunk size
    view.setUint16(20, 1, true); // compression code (1 = PCM)
    view.setUint16(22, 1, true); // channel count
    view.setUint32(24, sampleRate, true); // sample rate
    view.setUint32(28, sampleRate * 2, true); // avg bytes per second
    view.setUint16(32, 2, true); // block align
    view.setUint16(34, 16, true); // bits per sample
    // DATA chunk
    writeString(view, 36, 'data');
    view.setUint32(40, dataLength, true); // chunk size

    // Write PCM data
    let offset = 44;
    for (let i = 0; i < pcm16.length; i++) {
        view.setInt16(offset, pcm16[i], true);
        offset += 2;
    }

    return new Blob([view], { type: 'audio/wav' });
}

function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
    }
}

// Initial dummy messages for a richer starting experience
const initialMessages = [
    {
        id: 'dummy-1',
        recipient: 'The Stars Above',
        messageText: 'I hope you\'re shining brightly wherever you are. Missing your guidance.',
        timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
        likes: 7,
        likedBy: []
    },
    {
        id: 'dummy-2',
        recipient: 'My Childhood Dream',
        messageText: 'Still holding onto you, even if the path has changed. Never forgotten.',
        timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000), // 3 days ago
        likes: 12,
        likedBy: []
    },
    {
        id: 'dummy-3',
        recipient: 'The Quiet Moment',
        messageText: 'Cherishing the moments we shared together. Thank you for everything.',
        timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), // 1 day ago
        likes: 5,
        likedBy: []
    }
];


const App = () => {
    const [app, setApp] = useState(null);
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [messages, setMessages] = useState([]);
    const [recipient, setRecipient] = useState('');
    const [messageText, setMessageText] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const audioContextRef = useRef(null);
    const currentAudioSourceRef = useRef(null);

    // Modals for feedback
    const [showSuccessModal, setShowSuccessModal] = useState(false);
    const [showErrorModal, setShowErrorModal] = useState(false);
    const [modalMessage, setModalMessage] = useState('');
    const [showAboutModal, setShowAboutModal] = useState(false);

    // Animation state
    const [sentMessagesAnimations, setSentMessagesAnimations] = useState([]);
    const [backgroundWhispers, setBackgroundWhispers] = useState([]); // This state is now always empty

    // Page navigation state
    const [currentPage, setCurrentPage] = useState('home');

    // State for search term (REMOVED from active use, but kept in comments for reference)
    // const [searchTerm, setSearchTerm] = useState('');

    useEffect(() => {
        let unsubscribeAuth = () => {};

        const initializeFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                if (Object.keys(firebaseConfig).length === 0) {
                    setError("Firebase configuration not found. Please ensure __firebase_config is set.");
                    setModalMessage("Firebase configuration not found. Please ensure __firebase_config is set.");
                    setShowErrorModal(true);
                    return;
                }

                const firebaseApp = initializeApp(firebaseConfig);
                const firestoreDb = getFirestore(firebaseApp);
                const firebaseAuth = getAuth(firebaseApp);

                setApp(firebaseApp);
                setDb(firestoreDb);
                setAuth(firebaseAuth);

                // --- ENABLE OFFLINE PERSISTENCE HERE ---
                try {
                    await enableIndexedDbPersistence(firestoreDb);
                    console.log("Offline persistence enabled successfully!");
                } catch (err) {
                    if (err.code === 'failed-precondition') {
                        // Multiple tabs open, persistence can only be enabled in one tab.
                        // OR unsupported browser.
                        console.warn("Offline persistence not enabled (failed-precondition). Likely multiple tabs open or unsupported browser.", err);
                    } else if (err.code === 'unimplemented') {
                        // The current browser does not support all of the
                        // features required to enable persistence
                        console.warn("Offline persistence not enabled (unimplemented). Browser might not support it.", err);
                    } else {
                        console.error("Error enabling offline persistence:", err);
                        setModalMessage(`Failed to enable offline mode: ${err.message}`);
                        setShowErrorModal(true);
                    }
                }
                // --- END OFFLINE PERSISTENCE ---

                let hasAttemptedSignIn = false;

                unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setIsAuthReady(true);
                    } else {
                        if (!hasAttemptedSignIn) {
                            try {
                                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                                if (initialAuthToken) {
                                    await signInWithCustomToken(firebaseAuth, initialAuthToken);
                                } else {
                                    await signInAnonymously(firebaseAuth);
                                }
                            } catch (e) {
                                console.error("Firebase authentication failed:", e);
                                setError(`Authentication failed: ${e.message}. You might not be able to interact with the app fully.`);
                                setModalMessage(`Authentication failed: ${e.message}. You might not be able to interact with the app fully.`);
                                setShowErrorModal(true);
                                setIsAuthReady(true);
                                setUserId(crypto.randomUUID()); // Fallback for unauthenticated users
                            } finally {
                                hasAttemptedSignIn = true;
                            }
                        } else {
                            setIsAuthReady(true);
                            setUserId(crypto.randomUUID()); // Fallback for unauthenticated users
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase initialization error:", e);
                setError(`Failed to initialize Firebase: ${e.message}`);
                setModalMessage(`Failed to initialize Firebase: ${e.message}`);
                setShowErrorModal(true);
            }
        };

        initializeFirebase(); // Call the async initialization function

        return () => {
            if (unsubscribeAuth) unsubscribeAuth();
        };
    }, []); // Empty dependency array means this runs once on mount


    useEffect(() => {
        if (!db || !userId || !isAuthReady) {
            console.log("Firestore or Auth not ready, skipping snapshot listener.");
            // If Firebase is not ready, just display initial messages
            const sortedInitialMessages = [...initialMessages].sort((a, b) => {
                const aTime = a.timestamp ? a.timestamp.getTime() : 0;
                const bTime = b.timestamp ? b.timestamp.getTime() : 0;
                return bTime - aTime;
            });
            setMessages(sortedInitialMessages);
            return;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const messagesCollectionRef = collection(db, `/artifacts/${appId}/public/data/windPhoneMessages`);
        const q = query(messagesCollectionRef, orderBy('timestamp', 'desc'));

        console.log("Setting up onSnapshot listener for messages..."); // Added log

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedMessages = snapshot.docs.map(doc => ({
                id: doc.id,
                isFirestore: true, // Mark as a Firestore message
                ...doc.data(),
                likes: doc.data().likes || 0,
                likedBy: doc.data().likedBy || [],
                // Ensure timestamp is a Date object for consistent handling
                timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : null
            }));

            console.log("Fetched messages from Firestore:", fetchedMessages); // Added log

            // Combine fetched messages with initial messages, prioritizing fetched messages
            const combinedMessages = [
                ...fetchedMessages,
                ...initialMessages.filter(
                    (initMsg) => !fetchedMessages.some((fetchedMsg) => fetchedMsg.id === initMsg.id)
                ).map(msg => ({...msg, isFirestore: false})) // Mark initial messages
            ].sort((a, b) => {
                const aTime = a.timestamp ? a.timestamp.getTime() : 0;
                const bTime = b.timestamp ? b.timestamp.getTime() : 0;
                return bTime - aTime;
            });

            console.log("Combined messages (including initial ones):", combinedMessages); // Added log
            setMessages(combinedMessages);
        }, (err) => {
            console.error("Error fetching messages:", err);
            setError(`Failed to load messages: ${err.message}`);
            setModalMessage(`Failed to load messages: ${err.message}`);
            setShowErrorModal(true);
            // Fallback to initial messages if Firestore fetch fails
            const sortedInitialMessages = [...initialMessages].sort((a, b) => {
                const aTime = a.timestamp ? a.timestamp.getTime() : 0;
                const bTime = b.timestamp ? b.timestamp.getTime() : 0;
                // FIX: Corrected typo here (was bBime - aTime)
                return bTime - aTime;
            }).map(msg => ({...msg, isFirestore: false})); // Mark initial messages
            setMessages(sortedInitialMessages);
        });

        return () => unsubscribe();
    }, [db, userId, isAuthReady]);

    const handleLeaveMessage = async () => {
        setError('');
        setModalMessage('');
        setShowErrorModal(false);
        setShowSuccessModal(false);

        if (!recipient.trim()) {
            setError("Please enter a recipient.");
            setModalMessage("Please enter a recipient for your message.");
            setShowErrorModal(true);
            return;
        }
        if (!messageText.trim()) {
            setError("Please enter your message text.");
            setModalMessage("Please enter your message text.");
            setShowErrorModal(true);
            return;
        }
        if (!db || !userId || !isAuthReady) {
            setError("App is not ready. Please wait for initialization.");
            setModalMessage("App is not ready. Please wait for Firebase initialization and authentication.");
            setShowErrorModal(true);
            return;
        }

        setLoading(true);

        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Generate a random initial number of likes (e.g., between 1 and 5)
            const initialLikes = Math.floor(Math.random() * 5) + 1;

            const docRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/windPhoneMessages`), {
                userId: userId,
                recipient: recipient.trim(),
                messageText: messageText.trim(),
                timestamp: serverTimestamp(),
                likes: initialLikes, // Set random initial likes
                likedBy: []
            });
            console.log("Message successfully added to Firestore with ID:", docRef.id); // Added log

            // Trigger multiple flying animations (RESTORED)
            const numPlanes = Math.floor(Math.random() * 3) + 3; // 3 to 5 planes
            const newAnimations = [];
            for (let i = 0; i < numPlanes; i++) {
                newAnimations.push({
                    id: crypto.randomUUID(),
                    duration: Math.random() * 1.5 + 1.5, // 1.5 to 3 seconds
                    delay: Math.random() * 0.5, // 0 to 0.5 seconds
                    startY: Math.random() * 20 + 70, // Start around button area (70-90vh)
                    startX: Math.random() * 20 + 40, // Start around center (40-60vw)
                    endXOffset: Math.random() * 60 - 30, // -30vw to 30vw from center
                    endYOffset: Math.random() * 80 + 100, // Fly up 100-180vh
                    size: Math.random() * 1 + 1.5, // 1.5 to 2.5rem
                    rotation: Math.random() * 720 - 360, // -360 to 360 degrees
                });
            }
            setSentMessagesAnimations(newAnimations);


            setTimeout(() => {
                setSentMessagesAnimations([]); // Clear animations after they finish (RESTORED)
                setMessageText('');
                setRecipient('');
                setModalMessage("Your message has been sent to the wind!");
                setShowSuccessModal(true);
                setLoading(false);
            }, 3000); // Max animation duration (3s) + buffer (RESTORED)

        } catch (e) {
            console.error("Error adding message:", e);
            setError(`Failed to leave message: ${e.message}`);
            setModalMessage(`Failed to leave message: ${e.message}`);
            setShowErrorModal(true);
            setLoading(false);
        }
    };

    const handlePlayMessage = async (message) => {
        setError('');
        setModalMessage('');
        setShowErrorModal(false);
        setShowSuccessModal(false);
        setLoading(true);

        if (currentAudioSourceRef.current) {
            currentAudioSourceRef.current.pause();
            currentAudioSourceRef.current = null;
        }

        if (message.messageText) {
            try {
                if (!audioContextRef.current) {
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                }

                const payload = {
                    contents: [{
                        parts: [{ text: message.messageText }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Zephyr" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.play();

                    currentAudioSourceRef.current = audio;
                    audio.onended = () => {
                        currentAudioSourceRef.current = null;
                        setLoading(false);
                    };

                } else {
                    setError("Failed to generate or decode audio. Unexpected API response structure.");
                    setModalMessage("Failed to generate or decode audio from TTS. Please try again later.");
                    setShowErrorModal(true);
                    console.error("API response for audio:", result);
                    setLoading(false);
                }
            } catch (e) {
                console.error("Error playing message (TTS):", e);
                setError(`Failed to play message: ${e.message}. Ensure your browser supports TTS playback.`);
                setModalMessage(`Failed to play message: ${e.message}. Ensure your browser supports TTS playback.`);
                setShowErrorModal(true);
                setLoading(false);
            }
        } else {
            setError("No text content to play for this message.");
            setModalMessage("No text content to play for this message.");
            setShowErrorModal(true);
            setLoading(false);
        }
    };

    const handleLikeMessage = async (messageId, currentLikes, likedByArray, isFirestoreMessage) => {
        if (!userId || !isAuthReady) {
            setModalMessage("Authentication required to like messages.");
            setShowErrorModal(true);
            return;
        }

        const hasUserLiked = likedByArray.includes(userId);

        if (isFirestoreMessage) {
            if (!db) {
                setModalMessage("Database not ready. Cannot update message.");
                setShowErrorModal(true);
                return;
            }
            const messageRef = doc(db, `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/windPhoneMessages`, messageId);
            try {
                await updateDoc(messageRef, {
                    likes: hasUserLiked ? increment(-1) : increment(1),
                    likedBy: hasUserLiked ? arrayRemove(userId) : arrayUnion(userId)
                });
            } catch (e) {
                console.error("Error liking Firestore message:", e);
                setModalMessage(`Failed to update like status: ${e.message}.`);
                setShowErrorModal(true);
            }
        } else {
            // This is an initial (dummy) message, update state locally
            setMessages(prevMessages => prevMessages.map(msg => {
                if (msg.id === messageId) {
                    const newLikedBy = hasUserLiked
                        ? msg.likedBy.filter(id => id !== userId)
                        : [...msg.likedBy, userId];
                    return {
                        ...msg,
                        likes: hasUserLiked ? msg.likes - 1 : msg.likes + 1,
                        likedBy: newLikedBy
                    };
                }
                return msg;
            }));
        }
    };

    const closeErrorModal = () => setShowErrorModal(false);
    const closeAboutModal = () => setShowAboutModal(false);

    useEffect(() => {
        let timer;
        if (showSuccessModal) {
            timer = setTimeout(() => {
                setShowSuccessModal(false);
            }, 3000); // Restored timeout for success modal
        }
        return () => clearTimeout(timer);
    }, [showSuccessModal]);

    // Effect for generating background whispers - NOW EMPTY TO REMOVE ALL WHISPERS
    useEffect(() => {
        // Clear any existing whispers when component mounts or page changes
        setBackgroundWhispers([]);
        // The interval is no longer set, so no new whispers will be added.
    }, [currentPage]);


    const renderHomePage = () => (
        <>
            {/* Header Section */}
            <div className="w-full max-w-2xl bg-white bg-opacity-95 p-6 rounded-3xl shadow-xl mb-8 border-t-8 border-blue-400 transform hover:scale-105 transition-transform duration-300 ease-in-out">
                <h1 className="text-5xl md:text-6xl font-extrabold text-center text-blue-800 mb-4 tracking-tight leading-tight">
                    Memories on the Wind
                </h1>
                <p className="text-center text-xl md:text-2xl text-gray-700 leading-relaxed mt-3 italic">
                    "Though we may not hear a reply, the wind carries our words."
                </p>
                <div className="flex flex-col md:flex-row justify-center space-y-3 md:space-y-0 md:space-x-4 mt-6">
                    <button
                        onClick={() => setShowAboutModal(true)}
                        className="bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-2 px-5 rounded-full text-sm shadow-md transition-all duration-200 ease-in-out transform hover:scale-105"
                    >
                        Learn More About The Wind Phone
                    </button>
                    <button
                        onClick={() => setCurrentPage('messages')}
                        className="bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-2 px-5 rounded-full text-sm shadow-md transition-all duration-200 ease-in-out transform hover:scale-105"
                    >
                        Hear the wind
                    </button>
                </div>
            </div>

            {/* Message Input Section */}
            <div className="w-full max-w-2xl bg-white bg-opacity-95 p-8 rounded-3xl shadow-xl mb-8 border-l-8 border-cyan-400 hover:shadow-2xl transition-shadow duration-300 ease-in-out">
                <h2 className="text-3xl font-bold text-blue-700 mb-5 border-b pb-3 border-cyan-200">Send a Wind Message</h2>
                <div className="mb-5">
                    <label htmlFor="recipient" className="block text-gray-700 text-base font-semibold mb-2">
                        Who is this message for? <span className="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        id="recipient"
                        className="shadow-sm appearance-none border border-gray-300 rounded-xl w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition duration-300 ease-in-out text-lg"
                        value={recipient}
                        onChange={(e) => setRecipient(e.target.value)}
                        placeholder="e.g., My Dear Friend Alex"
                        disabled={loading}
                    />
                </div>
                <div className="mb-6">
                    <label htmlFor="messageText" className="block text-gray-700 text-base font-semibold mb-2">
                        Your Message: <span className="text-red-500">*</span>
                    </label>
                    <textarea
                        id="messageText"
                        className="shadow-sm appearance-none border border-gray-300 rounded-xl w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition duration-300 ease-in-out h-40 resize-y text-lg"
                        value={messageText}
                        onChange={(e) => setMessageText(e.target.value)}
                        placeholder="Share your thoughts, feelings, or memories here..."
                        disabled={loading}
                    ></textarea>
                </div>

                <button
                    onClick={handleLeaveMessage}
                    className="w-full bg-gradient-to-r from-indigo-400 to-purple-400 hover:from-indigo-500 hover:to-purple-500 text-white font-extrabold py-4 px-8 rounded-full text-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-indigo-300 focus:ring-offset-2 transition-all duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-3"
                    disabled={loading || (!messageText.trim() || !recipient.trim())}
                >
                    {loading ? (
                        <svg className="animate-spin -ml-1 mr-3 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    ) : (
                        <>
                            <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            <span>Send Message to the Wind</span>
                        </>
                    )}
                </button>
            </div>
        </>
    );

    const renderMessagesPage = () => {
        // Removed search term state and filtering logic from here.
        // All messages will be displayed.

        return (
            <div className="relative w-full max-w-3xl bg-white bg-opacity-95 p-8 rounded-3xl shadow-xl border-t-8 border-purple-400 overflow-hidden min-h-[70vh]">
                <h2 className="text-4xl font-extrabold text-blue-800 text-center mb-6 tracking-tight relative z-10">Messages Carried by the Wind</h2>
                <p className="text-center text-lg text-gray-700 italic mb-8 relative z-10">A collection of whispers and memories, touched by the breeze.</p>

                {/* Search Input (REMOVED from active code) */}
                {/*
                <div className="mb-8 relative z-10 flex items-center justify-center">
                    <div className="relative w-full max-w-md">
                        <input
                            type="text"
                            placeholder="Search messages by recipient or content..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full py-3 pl-12 pr-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:border-blue-400 transition duration-200 ease-in-out text-base text-gray-700 shadow-sm bg-gray-50 hover:bg-white"
                        />
                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                </div>
                */}

                <button
                    onClick={() => setCurrentPage('home')}
                    className="mb-8 mx-auto block bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-2 px-5 rounded-full text-sm shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 relative z-10"
                >
                    ← Back to Home
                </button>
                {messages.length === 0 && !loading ? ( // Now checking original 'messages' array
                    <p className="text-gray-600 italic text-center p-4 text-lg relative z-10">No wind whispers have been sent, Send</p>
                ) : (
                    <div className="space-y-6 relative z-10">
                        {messages.map((message) => { // Now mapping original 'messages' array
                            const hasUserLiked = message.likedBy && message.likedBy.includes(userId);
                            return (
                                <div key={message.id} className="cloud-message-card relative overflow-hidden">
                                    <div className="relative z-10 p-6">
                                        <p className="text-sm text-gray-500 mb-2 flex justify-between items-center">
                                            <span className="font-medium text-gray-600">To: <span className="font-semibold text-blue-700">{message.recipient}</span></span>
                                            {message.timestamp && (
                                                <span className="text-xs text-gray-400">
                                                    Sent: {new Date(message.timestamp).toLocaleDateString()}
                                                </span>
                                            )}
                                        </p>
                                        {message.messageText && <p className="text-gray-800 leading-relaxed text-lg mb-4">{message.messageText}</p>}
                                        <div className="flex justify-between items-center mt-2">
                                            <div className="flex items-center space-x-2">
                                                <button
                                                    // Pass 'isFirestore' flag to distinguish between Firestore and local messages
                                                    onClick={() => handleLikeMessage(message.id, message.likes, message.likedBy, message.isFirestore)}
                                                    className={`flex items-center space-x-1 p-2 rounded-full transition-colors duration-200 ${
                                                        hasUserLiked
                                                            ? 'text-red-500 hover:text-red-600'
                                                            : 'text-gray-400 hover:text-red-400'
                                                    } disabled:opacity-50 disabled:cursor-not-allowed`}
                                                    disabled={!userId || !isAuthReady}
                                                    aria-label={hasUserLiked ? "Unlike message" : "Like message"}
                                                >
                                                    <svg className="w-6 h-6" fill={hasUserLiked ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                                    </svg>
                                                    <span className="text-sm font-semibold">{message.likes}</span>
                                                </button>
                                            </div>
                                            <button
                                                onClick={() => handlePlayMessage(message)}
                                                className="bg-gradient-to-r from-blue-400 to-teal-400 hover:from-blue-500 hover:to-teal-500 text-white font-bold py-2 px-5 rounded-full text-base shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-offset-2 transition-all duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                                                disabled={loading || !message.messageText}
                                            >
                                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3.25-2a1 1 0 000-1.664l-3.25-2z" clipRule="evenodd"></path></svg>
                                                <span>Listen to Message</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        );
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col items-center p-4 font-inter text-gray-800 antialiased">
            <style>
                {`
                /* Animation for a single plane (used for the flurry) */
                @keyframes send-message-flurry {
                    0% {
                        transform: translate(var(--start-x), var(--start-y)) rotate(var(--start-rotation)) scale(0.8);
                        opacity: 0;
                    }
                    10% {
                        opacity: 1;
                    }
                    100% {
                        transform: translate(var(--end-x), var(--end-y)) rotate(var(--end-rotation)) scale(0);
                        opacity: 0;
                    }
                }

                .flying-message-flurry-animation {
                    position: fixed;
                    z-index: 1000;
                    animation-fill-mode: forwards;
                }


                @keyframes cloud-pop-in {
                    0% {
                        transform: scale(0.5) translateY(50px);
                        opacity: 0;
                    }
                    100% {
                        transform: scale(1) translateY(0);
                        opacity: 1;
                    }
                }

                .cloud-modal-animation {
                    animation: cloud-pop-in 0.5s ease-out forwards;
                }

                .about-modal-content {
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 1.5rem;
                    padding: 2rem;
                    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
                    max-width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                }

                .about-modal-backdrop {
                    position: fixed;
                    inset: 0;
                    background: rgba(0, 0, 0, 0.4);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                }

                /* Cloud-like message card styling */
                .cloud-message-card {
                    border-radius: 3.5rem;
                    box-shadow: 0 10px 30px rgba(100, 150, 200, 0.2), 0 5px 15px rgba(100, 150, 200, 0.1);
                    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,248,255,0.85));
                    border: none;
                    transition: all 0.3s ease-in-out;
                }
                .cloud-message-card:hover {
                    transform: translateY(-5px) scale(1.005);
                    box-shadow: 0 15px 40px rgba(100, 150, 200, 0.3), 0 8px 20px rgba(100, 150, 200, 0.15);
                }

                /* Background whisper animation */
                @keyframes bg-fly-away {
                    0% {
                        transform: translate(-50%, 0vh) rotate(var(--rotation, 0deg)) scale(1);
                        opacity: 0;
                    }
                    20% {
                        opacity: var(--max-opacity, 0.4);
                    }
                    80% {
                        opacity: var(--min-opacity, 0.1);
                    }
                    100% {
                        transform: translate(calc(var(--end-x) - 50%), var(--end-y)) rotate(var(--rotation, 0deg)) scale(0.5);
                        opacity: 0;
                    }
                }
                `}
            </style>

            {/* Render content based on currentPage state */}
            {currentPage === 'home' && renderHomePage()}
            {currentPage === 'messages' && renderMessagesPage()}

            {/* Render multiple flying message animations (RESTORED) */}
            {sentMessagesAnimations.map((plane) => (
                <div
                    key={plane.id}
                    className="flying-message-flurry-animation absolute"
                    style={{
                        top: `${plane.startY}vh`,
                        left: `${plane.startX}vw`,
                        animation: `send-message-flurry ${plane.duration}s ease-out ${plane.delay}s forwards`,
                        width: `${plane.size}rem`,
                        height: `${plane.size}rem`,
                        '--start-x': '0vw', // Start relative to its 'left'
                        '--start-y': '0vh', // Start relative to its 'top'
                        '--end-x': `${plane.endXOffset}vw`,
                        '--end-y': `-${plane.endYOffset}vh`,
                        '--start-rotation': `${plane.rotation}deg`,
                        '--end-rotation': `${plane.rotation + 360}deg`, // Spin a full circle
                        color: '#60a5fa', // Light blue paper plane
                        opacity: 0, // Starts invisible, animation controls opacity
                    }}
                >
                    <svg className="w-full h-full" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </div>
            ))}

            {showSuccessModal && (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-30 flex items-center justify-center z-50 p-4">
                    <div className="relative bg-white rounded-full py-10 px-16 shadow-2xl max-w-sm w-full text-center flex items-center justify-center cloud-modal-animation">
                        <div className="text-green-500 text-6xl mr-4">
                            <svg className="w-20 h-20" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"></path></svg>
                        </div>
                        <div>
                            <h3 className="text-2xl font-bold text-gray-800 mb-2">Message Sent!</h3>
                            <p className="text-gray-700 text-lg">{modalMessage}</p>
                        </div>
                    </div>
                </div>
            )}

            {showErrorModal && (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-8 shadow-2xl max-w-sm w-full text-center border-t-8 border-red-500 animate-fade-in-up">
                        <div className="text-red-500 text-6xl mb-4 animate-shake">
                            <svg className="mx-auto w-20 h-20" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"></path></svg>
                        </div>
                        <h3 className="text-2xl font-bold mb-3 text-gray-800">Error!</h3>
                        <p className="text-gray-700 text-lg mb-6">{modalMessage}</p>
                        <button
                            onClick={closeErrorModal}
                            className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg focus:outline-none focus:ring-4 focus:ring-red-300 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105"
                        >
                            Got It
                        </button>
                    </div>
                </div>
            )}

            {showAboutModal && (
                <div className="about-modal-backdrop" onClick={closeAboutModal}>
                    <div className="about-modal-content" onClick={e => e.stopPropagation()}>
                        <button
                            onClick={closeAboutModal}
                            className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-bold leading-none"
                            aria-label="Close"
                        >
                            &times;
                        </button>
                        <h2 className="text-4xl font-extrabold text-blue-700 mb-4 pb-2 border-b border-gray-200">
                            What is a Wind Phone?
                        </h2>
                        <p className="text-lg text-gray-800 mb-4">
                            The concept of a "Wind Phone" originated in Ōtsuchi, Japan, created by **Itaru Sasaki** in 2010 after losing his cousin. It was a disconnected telephone booth where he could speak to his deceased loved one, feeling that his words would be carried on the wind.
                        </p>
                        <p className="text-lg text-gray-800 mb-4">
                            After the devastating 2011 Tōhoku earthquake and tsunami, Sasaki opened the wind phone to the public. It became a profound **place of solace and connection** for thousands who had lost family and friends in the disaster.
                        </p>
                        <p className="text-lg text-gray-800 mb-4">
                            Our digital Wind Phone app aims to create a similar space—a virtual sanctuary where you can compose messages, speak your heart, and feel a sense of connection to those you miss, knowing your words are released to the unseen currents.
                        </p>
                        <p className="text-lg text-gray-800 italic">
                            It's a testament to enduring love and the human need to express the unsaid.
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};

export default App;
