<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memories on the Wind</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for animations and specific elements */
        .antialiased {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Animation for a single plane (used for the flurry) */
        @keyframes send-message-flurry {
            0% {
                transform: translate(var(--start-x), var(--start-y)) rotate(var(--start-rotation)) scale(0.8);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                transform: translate(var(--end-x), var(--end-y)) rotate(var(--end-rotation)) scale(0);
                opacity: 0;
            }
        }

        .flying-message-flurry-animation {
            position: fixed;
            z-index: 1000;
            animation-fill-mode: forwards;
        }

        @keyframes cloud-pop-in {
            0% {
                transform: scale(0.5) translateY(50px);
                opacity: 0;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .cloud-modal-animation {
            animation: cloud-pop-in 0.5s ease-out forwards;
        }

        .about-modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .about-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* Cloud-like message card styling */
        .cloud-message-card {
            border-radius: 3.5rem;
            box-shadow: 0 10px 30px rgba(100, 150, 200, 0.2), 0 5px 15px rgba(100, 150, 200, 0.1);
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,248,255,0.85));
            border: none;
            transition: all 0.3s ease-in-out;
        }
        .cloud-message-card:hover {
            transform: translateY(-5px) scale(1.005);
            box-shadow: 0 15px 40px rgba(100, 150, 200, 0.3), 0 8px 20px rgba(100, 150, 200, 0.15);
        }

        /* Animation for error modal shake */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
        }

        /* Animation for fade-in-up */
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col items-center p-4 antialiased">

    <!-- Main App Container -->
    <div id="app-root" class="flex flex-col items-center w-full max-w-4xl">
        <!-- Render content based on currentPage state, filled by JavaScript -->
    </div>

    <!-- Modals (initially hidden) -->
    <div id="successModal" class="fixed inset-0 bg-gray-800 bg-opacity-30 flex items-center justify-center z-50 p-4 hidden">
        <div class="relative bg-white rounded-full py-10 px-16 shadow-2xl max-w-sm w-full text-center flex items-center justify-center cloud-modal-animation">
            <div class="text-green-500 text-6xl mr-4">
                <svg class="w-20 h-20" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1  0 001.414 0l4-4z" clipRule="evenodd"></path></svg>
            </div>
            <div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Message Sent!</h3>
                <p id="successModalMessage" class="text-gray-700 text-lg"></p>
            </div>
        </div>
    </div>

    <div id="errorModal" class="fixed inset-0 bg-gray-800 bg-opacity-70 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl p-8 shadow-2xl max-w-sm w-full text-center border-t-8 border-red-500 animate-fade-in-up">
            <div class="text-red-500 text-6xl mb-4 animate-shake">
                <svg class="mx-auto w-20 h-20" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"></path></svg>
            </div>
            <h3 class="text-2xl font-bold mb-3 text-gray-800">Error!</h3>
            <p id="errorModalMessage" class="text-gray-700 text-lg mb-6"></p>
            <button id="closeErrorModalBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg focus:outline-none focus:ring-4 focus:ring-red-300 focus:ring-offset-2 transition duration-300 ease-in-out transform hover:scale-105">
                Got It
            </button>
        </div>
    </div>

    <div id="aboutModal" class="about-modal-backdrop hidden">
        <div class="about-modal-content">
            <button id="closeAboutModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-bold leading-none" aria-label="Close">
                &times;
            </button>
            <h2 class="text-4xl font-extrabold text-blue-700 mb-4 pb-2 border-b border-gray-200">
                What is a Wind Phone?
            </h2>
            <p class="text-lg text-gray-800 mb-4">
                The concept of a "Wind Phone" originated in Ōtsuchi, Japan, created by <strong>Itaru Sasaki</strong> in 2010 after losing his cousin. It was a disconnected telephone booth where he could speak to his deceased loved one, feeling that his words would be carried on the wind.
            </p>
            <p class="text-lg text-gray-800 mb-4">
                After the devastating 2011 Tōhoku earthquake and tsunami, Sasaki opened the wind phone to the public. It became a profound <strong>place of solace and connection</strong> for thousands who had lost family and friends in the disaster.
            </p>
            <p class="text-lg text-gray-800 mb-4">
                Our digital Wind Phone app aims to create a similar space—a virtual sanctuary where you can compose messages, speak your heart, and feel a sense of connection to those you miss, knowing your words are released to the unseen currents.
            </p>
            <p class="text-lg text-gray-800 italic">
                It's a testament to enduring love and the human need to express the unsaid.
            </p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion, arrayRemove, increment, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- IMPORTANT: Replace these with your actual Firebase project configuration ---
        // You can find this in your Firebase project settings -> "Your apps" -> "Web app" -> "Config"
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
            // measurementId: "YOUR_MEASUREMENT_ID" // Optional
        };

        // This is the app ID used in your Firestore collection path
        // It's often the same as projectId, but can be explicitly defined in Firebase.
        const YOUR_APP_IDENTIFIER = "YOUR_PROJECT_ID_OR_APP_ID_FOR_FIRESTORE_PATH"; // e.g., "your-project-id"
        // --- END IMPORTANT CONFIGURATION ---


        // Global State Variables
        let fbApp;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let messages = [];
        let currentPage = 'home'; // 'home' or 'messages'
        let currentAudioSource = null;
        let audioContext = null;
        let sentMessagesAnimations = []; // For the flying paper plane animation

        // Initial dummy messages for a richer starting experience
        const initialMessages = [
            {
                id: 'dummy-1',
                recipient: 'The Stars Above',
                messageText: 'I hope you\'re shining brightly wherever you are. Missing your guidance.',
                timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), // 5 days ago
                likes: 7,
                likedBy: []
            },
            {
                id: 'dummy-2',
                recipient: 'My Childhood Dream',
                messageText: 'Still holding onto you, even if the path has changed. Never forgotten.',
                timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000), // 3 days ago
                likes: 12,
                likedBy: []
            },
            {
                id: 'dummy-3',
                recipient: 'The Quiet Moment',
                messageText: 'Cherishing the moments we shared together. Thank you for everything.',
                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000), // 1 day ago
                likes: 5,
                likedBy: []
            }
        ];

        // --- Helper Functions ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const dataLength = pcm16.length * 2; // 2 bytes per sample
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            // RIFF identifier
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true); // file length
            writeString(view, 8, 'WAVE');
            // FMT chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // chunk size
            view.setUint16(20, 1, true); // compression code (1 = PCM)
            view.setUint16(22, 1, true); // channel count
            view.setUint32(24, sampleRate, true); // sample rate
            view.setUint32(28, sampleRate * 2, true); // avg bytes per second
            view.setUint16(32, 2, true); // block align
            view.setUint16(34, 16, true); // bits per sample
            // DATA chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true); // chunk size

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // --- Modal Control Functions ---
        function showModal(modalId, message = '') {
            const modal = document.getElementById(modalId);
            if (modalId === 'successModal') {
                document.getElementById('successModalMessage').textContent = message;
            } else if (modalId === 'errorModal') {
                document.getElementById('errorModalMessage').textContent = message;
            }
            modal.classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- Firebase Initialization and Auth ---
        async function initializeFirebase() {
            try {
                // Use the directly embedded config and identifier
                const appId = YOUR_APP_IDENTIFIER;
                const firebaseConfig = YOUR_FIREBASE_CONFIG;

                if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                    showModal('errorModal', "Firebase configuration not set. Please update YOUR_FIREBASE_CONFIG and YOUR_APP_IDENTIFIER in the HTML file.");
                    return;
                }

                fbApp = initializeApp(firebaseConfig);
                db = getFirestore(fbApp);
                auth = getAuth(fbApp);

                try {
                    await enableIndexedDbPersistence(db);
                    console.log("Offline persistence enabled successfully!");
                } catch (err) {
                    if (err.code === 'failed-precondition') {
                        console.warn("Offline persistence not enabled (failed-precondition). Likely multiple tabs open or unsupported browser.", err);
                    } else if (err.code === 'unimplemented') {
                        console.warn("Offline persistence not enabled (unimplemented). Browser might not support it.", err);
                    } else {
                        console.error("Error enabling offline persistence:", err);
                        showModal('errorModal', `Failed to enable offline mode: ${err.message}`);
                    }
                }

                let hasAttemptedSignIn = false;
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("User authenticated:", userId);
                        renderApp(); // Re-render after auth
                    } else {
                        if (!hasAttemptedSignIn) {
                            try {
                                // For GitHub Pages, you typically won't have an __initial_auth_token.
                                // We'll always sign in anonymously here.
                                await signInAnonymously(auth);
                            } catch (e) {
                                console.error("Firebase authentication failed:", e);
                                showModal('errorModal', `Authentication failed: ${e.message}. You might not be able to interact with the app fully.`);
                                isAuthReady = true;
                                userId = crypto.randomUUID(); // Fallback for unauthenticated users
                                renderApp();
                            } finally {
                                hasAttemptedSignIn = true;
                            }
                        } else {
                            isAuthReady = true;
                            userId = crypto.randomUUID(); // Fallback for unauthenticated users
                            renderApp();
                        }
                    }
                });

            } catch (e) {
                console.error("Firebase initialization error:", e);
                showModal('errorModal', `Failed to initialize Firebase: ${e.message}`);
            }
        }

        // --- Message Handling Functions ---
        async function loadMessages() {
            if (!db || !userId || !isAuthReady) {
                console.log("Firestore or Auth not ready, skipping message load.");
                // Render initial messages if Firebase is not ready
                messages = [...initialMessages].sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
                renderApp();
                return;
            }

            const appId = YOUR_APP_IDENTIFIER; // Use the directly embedded identifier
            const messagesCollectionRef = collection(db, `/artifacts/${appId}/public/data/windPhoneMessages`);
            const q = query(messagesCollectionRef, orderBy('timestamp', 'desc'));

            console.log("Setting up onSnapshot listener for messages...");

            onSnapshot(q, (snapshot) => {
                const fetchedMessages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    isFirestore: true,
                    ...doc.data(),
                    likes: doc.data().likes || 0,
                    likedBy: doc.data().likedBy || [],
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : null
                }));

                console.log("Fetched messages from Firestore:", fetchedMessages);

                const combinedMessages = [
                    ...fetchedMessages,
                    ...initialMessages.filter(
                        (initMsg) => !fetchedMessages.some((fetchedMsg) => fetchedMsg.id === initMsg.id)
                    ).map(msg => ({...msg, isFirestore: false}))
                ].sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));

                console.log("Combined messages (including initial ones):", combinedMessages);
                messages = combinedMessages; // Update global messages array
                renderApp(); // Re-render the app to show updated messages
            }, (err) => {
                console.error("Error fetching messages:", err);
                showModal('errorModal', `Failed to load messages: ${err.message}`);
                // Fallback to initial messages if Firestore fetch fails
                messages = [...initialMessages].sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
                renderApp();
            });
        }

        async function handleLeaveMessage(event) {
            event.preventDefault(); // Prevent default form submission

            const recipientInput = document.getElementById('recipient');
            const messageTextInput = document.getElementById('messageText');

            const recipient = recipientInput.value.trim();
            const messageText = messageTextInput.value.trim();

            if (!recipient) {
                showModal('errorModal', "Please enter a recipient for your message.");
                return;
            }
            if (!messageText) {
                showModal('errorModal', "Please enter your message text.");
                return;
            }
            if (!db || !userId || !isAuthReady) {
                showModal('errorModal', "App is not ready. Please wait for Firebase initialization and authentication.");
                return;
            }

            document.getElementById('sendMessageBtn').disabled = true; // Disable button
            document.getElementById('sendMessageSpinner').classList.remove('hidden');
            document.getElementById('sendMessageIcon').classList.add('hidden');

            try {
                const appId = YOUR_APP_IDENTIFIER; // Use the directly embedded identifier
                const initialLikes = Math.floor(Math.random() * 5) + 1;

                const docRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/windPhoneMessages`), {
                    userId: userId,
                    recipient: recipient,
                    messageText: messageText,
                    timestamp: serverTimestamp(),
                    likes: initialLikes,
                    likedBy: []
                });
                console.log("Message successfully added to Firestore with ID:", docRef.id);

                // Trigger multiple flying animations
                const numPlanes = Math.floor(Math.random() * 3) + 3; // 3 to 5 planes
                sentMessagesAnimations = []; // Clear previous animations
                const animationContainer = document.getElementById('animationContainer');
                if (!animationContainer) {
                    const tempDiv = document.createElement('div');
                    tempDiv.id = 'animationContainer';
                    document.body.appendChild(tempDiv);
                }

                for (let i = 0; i < numPlanes; i++) {
                    const plane = {
                        id: crypto.randomUUID(),
                        duration: Math.random() * 1.5 + 1.5, // 1.5 to 3 seconds
                        delay: Math.random() * 0.5, // 0 to 0.5 seconds
                        startY: Math.random() * 20 + 70, // Start around button area (70-90vh)
                        startX: Math.random() * 20 + 40, // Start around center (40-60vw)
                        endXOffset: Math.random() * 60 - 30, // -30vw to 30vw from center
                        endYOffset: Math.random() * 80 + 100, // Fly up 100-180vh
                        size: Math.random() * 1 + 1.5, // 1.5 to 2.5rem
                        rotation: Math.random() * 720 - 360, // -360 to 360 degrees
                    };
                    sentMessagesAnimations.push(plane);

                    const planeEl = document.createElement('div');
                    planeEl.className = 'flying-message-flurry-animation absolute';
                    planeEl.style.cssText = `
                        top: ${plane.startY}vh;
                        left: ${plane.startX}vw;
                        animation: send-message-flurry ${plane.duration}s ease-out ${plane.delay}s forwards;
                        width: ${plane.size}rem;
                        height: ${plane.size}rem;
                        --start-x: 0vw;
                        --start-y: 0vh;
                        --end-x: ${plane.endXOffset}vw;
                        --end-y: -${plane.endYOffset}vh;
                        --start-rotation: ${plane.rotation}deg;
                        --end-rotation: ${plane.rotation + 360}deg;
                        color: #60a5fa;
                        opacity: 0;
                    `;
                    planeEl.innerHTML = `<svg class="w-full h-full" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>`;
                    document.getElementById('animationContainer').appendChild(planeEl);

                    // Remove the plane element after its animation finishes
                    setTimeout(() => {
                        planeEl.remove();
                    }, (plane.duration + plane.delay) * 1000);
                }


                setTimeout(() => {
                    sentMessagesAnimations = []; // Clear animations state
                    recipientInput.value = '';
                    messageTextInput.value = '';
                    showModal('successModal', "Your message has been sent to the wind!");
                    document.getElementById('sendMessageBtn').disabled = false;
                    document.getElementById('sendMessageSpinner').classList.add('hidden');
                    document.getElementById('sendMessageIcon').classList.remove('hidden');
                }, 3000); // Max animation duration (3s) + buffer

            } catch (e) {
                console.error("Error adding message:", e);
                showModal('errorModal', `Failed to leave message: ${e.message}`);
                document.getElementById('sendMessageBtn').disabled = false;
                document.getElementById('sendMessageSpinner').classList.add('hidden');
                document.getElementById('sendMessageIcon').classList.remove('hidden');
            }
        }

        async function handlePlayMessage(message) {
            if (currentAudioSource) {
                currentAudioSource.pause();
                currentAudioSource = null;
            }

            if (!message.messageText) {
                showModal('errorModal', "No text content to play for this message.");
                return;
            }

            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Simulate loading state for the specific message's button
                const playButton = document.querySelector(`[data-message-id="${message.id}"][data-action="play"]`);
                if(playButton) {
                    playButton.disabled = true;
                    playButton.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg><span>Loading...</span>`;
                }


                const payload = {
                    contents: [{
                        parts: [{ text: message.messageText }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Zephyr" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const apiKey = ""; // API key will be provided by Canvas runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    const audio = new Audio(audioUrl);
                    audio.play();

                    currentAudioSource = audio;
                    audio.onended = () => {
                        currentAudioSource = null;
                        if(playButton) {
                            playButton.disabled = false;
                            playButton.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3.25-2a1 1 0 000-1.664l-3.25-2z" clipRule="evenodd"></path></svg><span>Listen to Message</span>`;
                        }
                    };

                } else {
                    showModal('errorModal', "Failed to generate or decode audio. Unexpected API response structure.");
                    console.error("API response for audio:", result);
                }
            } catch (e) {
                console.error("Error playing message (TTS):", e);
                showModal('errorModal', `Failed to play message: ${e.message}. Ensure your browser supports TTS playback.`);
            } finally {
                if(playButton && currentAudioSource === null) { // Only re-enable if no audio is playing
                    playButton.disabled = false;
                    playButton.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3.25-2a1 1 0 000-1.664l-3.25-2z" clipRule="evenodd"></path></svg><span>Listen to Message</span>`;
                }
            }
        }

        async function handleLikeMessage(messageId, isFirestoreMessage) {
            if (!userId || !isAuthReady) {
                showModal('errorModal', "Authentication required to like messages.");
                return;
            }

            const message = messages.find(msg => msg.id === messageId);
            if (!message) return;

            const hasUserLiked = message.likedBy.includes(userId);

            if (isFirestoreMessage) {
                if (!db) {
                    showModal('errorModal', "Database not ready. Cannot update message.");
                    return;
                }
                const messageRef = doc(db, `/artifacts/${YOUR_APP_IDENTIFIER}/public/data/windPhoneMessages`, messageId); // Use directly embedded identifier
                try {
                    await updateDoc(messageRef, {
                        likes: hasUserLiked ? increment(-1) : increment(1),
                        likedBy: hasUserLiked ? arrayRemove(userId) : arrayUnion(userId)
                    });
                } catch (e) {
                    console.error("Error liking Firestore message:", e);
                    showModal('errorModal', `Failed to update like status: ${e.message}.`);
                }
            } else {
                // This is an initial (dummy) message, update state locally
                messages = messages.map(msg => {
                    if (msg.id === messageId) {
                        const newLikedBy = hasUserLiked
                            ? msg.likedBy.filter(id => id !== userId)
                            : [...msg.likedBy, userId];
                        return {
                            ...msg,
                            likes: hasUserLiked ? msg.likes - 1 : msg.likes + 1,
                            likedBy: newLikedBy
                        };
                    }
                    return msg;
                });
                renderApp(); // Re-render to reflect local change
            }
        }


        // --- UI Rendering Functions ---
        function renderHomePage() {
            return `
                <div class="w-full max-w-2xl bg-white bg-opacity-95 p-6 rounded-3xl shadow-xl mb-8 border-t-8 border-blue-400 transform hover:scale-105 transition-transform duration-300 ease-in-out">
                    <h1 class="text-5xl md:text-6xl font-extrabold text-center text-blue-800 mb-4 tracking-tight leading-tight">
                        Memories on the Wind
                    </h1>
                    <p class="text-center text-xl md:text-2xl text-gray-700 leading-relaxed mt-3 italic">
                        "Though we may not hear a reply, the wind carries our words."
                    </p>
                    <div class="flex flex-col md:flex-row justify-center space-y-3 md:space-y-0 md:space-x-4 mt-6">
                        <button id="learnMoreBtn" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-2 px-5 rounded-full text-sm shadow-md transition-all duration-200 ease-in-out transform hover:scale-105">
                            Learn More About The Wind Phone
                        </button>
                        <button id="hearWindBtn" class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-2 px-5 rounded-full text-sm shadow-md transition-all duration-200 ease-in-out transform hover:scale-105">
                            Hear the wind
                        </button>
                    </div>
                </div>

                <div class="w-full max-w-2xl bg-white bg-opacity-95 p-8 rounded-3xl shadow-xl mb-8 border-l-8 border-cyan-400 hover:shadow-2xl transition-shadow duration-300 ease-in-out">
                    <h2 class="text-3xl font-bold text-blue-700 mb-5 border-b pb-3 border-cyan-200">Send a Wind Message</h2>
                    <div class="mb-5">
                        <label for="recipient" class="block text-gray-700 text-base font-semibold mb-2">
                            Who is this message for? <span class="text-red-500">*</span>
                        </label>
                        <input
                            type="text"
                            id="recipient"
                            class="shadow-sm appearance-none border border-gray-300 rounded-xl w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition duration-300 ease-in-out text-lg"
                            placeholder="e.g., My Dear Friend Alex"
                        />
                    </div>
                    <div class="mb-6">
                        <label for="messageText" class="block text-gray-700 text-base font-semibold mb-2">
                            Your Message: <span class="text-red-500">*</span>
                        </label>
                        <textarea
                            id="messageText"
                            class="shadow-sm appearance-none border border-gray-300 rounded-xl w-full py-3 px-4 text-gray-800 leading-tight focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-400 transition duration-300 ease-in-out h-40 resize-y text-lg"
                            placeholder="Share your thoughts, feelings, or memories here..."
                        ></textarea>
                    </div>

                    <button id="sendMessageBtn" class="w-full bg-gradient-to-r from-indigo-400 to-purple-400 hover:from-indigo-500 hover:to-purple-500 text-white font-extrabold py-4 px-8 rounded-full text-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-indigo-300 focus:ring-offset-2 transition-all duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-3">
                        <svg id="sendMessageIcon" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        <svg id="sendMessageSpinner" class="animate-spin -ml-1 mr-3 h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Send Message to the Wind</span>
                    </button>
                </div>
                <div id="animationContainer" class="fixed inset-0 pointer-events-none z-50"></div>
            `;
        }

        function renderMessagesPage() {
            let messagesHtml = '';
            if (messages.length === 0) {
                messagesHtml = `<p class="text-gray-600 italic text-center p-4 text-lg relative z-10">No wind whispers have been sent, Send</p>`;
            } else {
                messagesHtml = messages.map(message => {
                    const hasUserLiked = message.likedBy && message.likedBy.includes(userId);
                    const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleDateString() : 'N/A';
                    return `
                        <div class="cloud-message-card relative overflow-hidden" data-message-id="${message.id}" data-is-firestore="${message.isFirestore}">
                            <div class="relative z-10 p-6">
                                <p class="text-sm text-gray-500 mb-2 flex justify-between items-center">
                                    <span class="font-medium text-gray-600">To: <span class="font-semibold text-blue-700">${message.recipient}</span></span>
                                    <span class="text-xs text-gray-400">
                                        Sent: ${timestamp}
                                    </span>
                                </p>
                                <p class="text-gray-800 leading-relaxed text-lg mb-4">${message.messageText}</p>
                                <div class="flex justify-between items-center mt-2">
                                    <div class="flex items-center space-x-2">
                                        <button
                                            class="flex items-center space-x-1 p-2 rounded-full transition-colors duration-200 ${hasUserLiked ? 'text-red-500 hover:text-red-600' : 'text-gray-400 hover:text-red-400'} disabled:opacity-50 disabled:cursor-not-allowed"
                                            data-message-id="${message.id}" data-action="like" ${!userId || !isAuthReady ? 'disabled' : ''}
                                            aria-label="${hasUserLiked ? 'Unlike message' : 'Like message'}"
                                        >
                                            <svg class="w-6 h-6" fill="${hasUserLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                            </svg>
                                            <span class="text-sm font-semibold">${message.likes}</span>
                                        </button>
                                    </div>
                                    <button
                                        class="bg-gradient-to-r from-blue-400 to-teal-400 hover:from-blue-500 hover:to-teal-500 text-white font-bold py-2 px-5 rounded-full text-base shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-offset-2 transition-all duration-200 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                                        data-message-id="${message.id}" data-action="play" ${!message.messageText ? 'disabled' : ''}
                                    >
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3.25-2a1 1 0 000-1.664l-3.25-2z" clipRule="evenodd"></path></svg>
                                        <span>Listen to Message</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }


            return `
                <div class="relative w-full max-w-3xl bg-white bg-opacity-95 p-8 rounded-3xl shadow-xl border-t-8 border-purple-400 overflow-hidden min-h-[70vh]">
                    <h2 class="text-4xl font-extrabold text-blue-800 text-center mb-6 tracking-tight relative z-10">Messages Carried by the Wind</h2>
                    <p class="text-center text-lg text-gray-700 italic mb-8 relative z-10">A collection of whispers and memories, touched by the breeze.</p>

                    <button id="backToHomeBtn" class="mb-8 mx-auto block bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold py-2 px-5 rounded-full text-sm shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 relative z-10">
                        ← Back to Home
                    </button>
                    <div class="space-y-6 relative z-10">
                        ${messagesHtml}
                    </div>
                </div>
            `;
        }

        function renderApp() {
            const appRoot = document.getElementById('app-root');
            if (currentPage === 'home') {
                appRoot.innerHTML = renderHomePage();
                // Add event listeners for home page
                document.getElementById('learnMoreBtn').addEventListener('click', () => showModal('aboutModal'));
                document.getElementById('hearWindBtn').addEventListener('click', () => {
                    currentPage = 'messages';
                    renderApp();
                });
                document.getElementById('sendMessageBtn').addEventListener('click', handleLeaveMessage);
            } else if (currentPage === 'messages') {
                appRoot.innerHTML = renderMessagesPage();
                // Add event listeners for messages page
                document.getElementById('backToHomeBtn').addEventListener('click', () => {
                    currentPage = 'home';
                    renderApp();
                });
                // Event delegation for like and play buttons
                appRoot.querySelectorAll('[data-action="like"]').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const messageId = event.currentTarget.dataset.messageId;
                        const isFirestore = event.currentTarget.closest('[data-is-firestore]').dataset.isFirestore === 'true';
                        handleLikeMessage(messageId, isFirestore);
                    });
                });
                appRoot.querySelectorAll('[data-action="play"]').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const messageId = event.currentTarget.dataset.messageId;
                        const message = messages.find(msg => msg.id === messageId);
                        if (message) handlePlayMessage(message);
                    });
                });
            }
        }

        // --- Event Listeners for Modals (Global) ---
        document.getElementById('closeErrorModalBtn').addEventListener('click', () => hideModal('errorModal'));
        document.getElementById('aboutModal').addEventListener('click', (event) => {
            if (event.target.id === 'aboutModal') { // Only close if backdrop clicked
                hideModal('aboutModal');
            }
        });
        document.getElementById('closeAboutModalBtn').addEventListener('click', () => hideModal('aboutModal'));


        // Initialize Firebase and render app on DOM load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeFirebase();
            loadMessages(); // Load messages once Firebase is ready and authenticated state is known
            // Initial render of the home page. Subsequent renders will be triggered by state changes.
            renderApp();
        });

    </script>
</body>
</html>
